<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda du Club Alpin</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
        darkMode: 'class'
    }
    </script>

  <style>
    /* Animation pour le bouton retour haut */
    #backToTop {
      transition: opacity 0.3s;
      opacity: 0;
      pointer-events: none;
    }
    #backToTop.show {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
      <h1 class="text-3xl font-bold">üìÖ Agenda des activit√©s</h1>
      <button id="toggleTheme" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 px-3 py-1 rounded">
        üåô Th√®me sombre
      </button>
    </div>

    <!-- Filtres -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Tous">Tous</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Randonn√©e">Randonn√©e</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Escalade">Escalade</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Alpinisme">Alpinisme</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Rando alpine">Rando alpine</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Multi-activit√©s">Multi-activit√©s</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Formation">Formation</button>
    </div>

    <!-- Recherche -->
    <div class="mb-4">
      <input id="searchInput" type="text" placeholder="Rechercher par titre ou lieu..."
        class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 rounded px-3 py-2">
    </div>

    <!-- Tri -->
    <div class="flex gap-2 mb-6">
      <button id="sortAsc" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded">Trier par date ‚Üë</button>
      <button id="sortDesc" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded">Trier par date ‚Üì</button>
    </div>

    <!-- Conteneur des √©v√©nements -->
    <div id="events" class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">Chargement...</div>
  </div>

  <!-- Bouton Retour Haut -->
  <button id="backToTop"
    class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full shadow-lg z-50">
    ‚Üë Haut
  </button>

  <script>
    const url = "https://clubalpin.nantes.ffcam.fr/index.php?&contentonly=1&moid=3&function=viewsection&oidit=T003:4fp41t2pd7d6&oidsection=b34179abe57cc45535ffcdf0babc96ff&template=viewsection.html&tplentry=it&sectionopts[b34179abe57cc45535ffcdf0babc96ff][first]=0&sectionopts[b34179abe57cc45535ffcdf0babc96ff][insidefilter]=1&activit=&_raw=1&_ajax=1";
    let eventsData = [];

    fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`)
      .then(response => response.json())
      .then(data => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, 'text/html');
        const rows = doc.querySelectorAll('.agenda_liste');
        eventsData = [];

        rows.forEach(row => {
          const activite = row.querySelector('.activite-logo img')?.alt || "Activit√© inconnue";
          const dateText = row.querySelectorAll('.agenda_listeTop')[0]?.innerText.trim() || "";
          const linkElement = row.querySelector('.agenda_listeTop a');
          const title = linkElement?.textContent.trim() || "Sans titre";
          const link = linkElement?.href || "#";
          const lieu = row.querySelectorAll('.agenda_listeTop')[2]?.innerText.trim() || "";
          const placesBloc = row.querySelectorAll('.agenda_listeTop')[3];
          let places = "";
          let niveauPhysique = "";
          let niveauTechnique = "";
          if (placesBloc) {
            places = placesBloc.innerText.trim().split("\n")[0];
            // R√©cup√©ration des niveaux via les balises <img>
            const imgs = placesBloc.querySelectorAll('img');
            imgs.forEach(img => {
              if (img.alt && img.alt.toLowerCase().includes('physique')) {
                // Cherche un chiffre dans le nom du fichier (ex: Forme-physique04.png)
                const match = img.src.match(/physique0(\d+)/i);
                niveauPhysique = match ? match[1] : (img.title || img.alt);
              }
              if (img.alt && img.alt.toLowerCase().includes('technique')) {
                const match = img.src.match(/Niveau0?(\d+)/i);
                niveauTechnique = match ? match[1] : (img.title || img.alt);
              }
            });
          }
          const dispo = row.querySelector('.places_restantes')?.innerText || "";
          const contact = row.querySelector('.contact-tel')?.innerText.trim() || "";

          let dateSort = new Date();
          const match = dateText.match(/(\d{2})\/(\d{2})\/(\d{4})/);
          if (match) {
            const [_, d, m, y] = match;
            dateSort = new Date(`${y}-${m}-${d}`);
          }

          eventsData.push({
            activite,
            dateText,
            dateSort,
            title,
            link,
            lieu,
            places,
            niveauPhysique,
            niveauTechnique,
            dispo,
            contact
          });
        });

        renderEvents(eventsData);
      })
      .catch(err => {
        console.error("Erreur:", err);
        document.getElementById('events').innerHTML = "<p class='text-red-500'>Impossible de charger l'agenda. V√©rifiez votre connexion.</p>";
      });

    function renderEvents(data) {
      const container = document.getElementById('events');
      container.innerHTML = "";
      data.forEach(ev => {
        const gcalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(ev.title)}&dates=${formatDate(ev.dateSort)}/${formatDate(ev.dateSort)}&details=${encodeURIComponent(ev.link)}&location=${encodeURIComponent(ev.lieu)}&sf=true&output=xml`;
        const card = document.createElement('div');
        card.className = "bg-white dark:bg-gray-800 shadow rounded p-4 flex flex-col justify-between transition-colors duration-300 min-h-[270px]";
        card.innerHTML = `
          <div>
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">${ev.activite}</span>
              <span class="text-sm text-gray-500 dark:text-gray-300">${ev.dateText}</span>
            </div>
            <h2 class="text-lg font-semibold mb-1">
              <a href="${ev.link.replace(/^http:\/\/127\.0\.0\.1:5500\//, 'https://clubalpin.nantes.ffcam.fr/')}" target="_blank" class="hover:underline">${ev.title}</a>
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">üìç ${ev.lieu || "<span class='italic text-gray-400'>Lieu non renseign√©</span>"}</p>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">üë§ ${ev.contact || "<span class='italic text-gray-400'>Contact non renseign√©</span>"}</p>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">
              üí™ <span title="Niveau physique">${ev.niveauPhysique || "<span class='italic text-gray-400'>-</span>"}</span>
              üßó <span title="Niveau technique">${ev.niveauTechnique || "<span class='italic text-gray-400'>-</span>"}</span>
            </p>
          </div>
          <div class="mt-3 flex flex-wrap gap-2 items-center">
            <span class="text-sm bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">${ev.places || "Places non renseign√©es"}</span>
            ${ev.dispo ? `<span class="text-sm bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 px-2 py-1 rounded">${ev.dispo}</span>` : ""}
            ${ev.link ? `<a href="${ev.link.replace(/^http:\/\/127\.0\.0\.1:5500\//, 'https://clubalpin.nantes.ffcam.fr/')}" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-3 py-1 rounded">S'inscrire</a>` : `<span class="inline-block bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 text-sm font-medium px-3 py-1 rounded cursor-not-allowed">Inscription indisponible</span>`}
            <a href="${gcalUrl}" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 text-white text-sm font-medium px-3 py-1 rounded">üìÖ Ajouter au calendrier</a>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function formatDate(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}${month}${day}`;
    }

    // Filtrage
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('filter-btn')) {
        const activity = e.target.dataset.activity;
        const filtered = activity === "Tous" ? eventsData : eventsData.filter(ev => ev.activite === activity);
        renderEvents(filtered);
      }
    });

    // Recherche
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = eventsData.filter(ev =>
        ev.title.toLowerCase().includes(term) || ev.lieu.toLowerCase().includes(term)
      );
      renderEvents(filtered);
    });

    // Tri
    document.getElementById('sortAsc').addEventListener('click', () => {
      const sorted = [...eventsData].sort((a, b) => a.dateSort - b.dateSort);
      renderEvents(sorted);
    });
    document.getElementById('sortDesc').addEventListener('click', () => {
      const sorted = [...eventsData].sort((a, b) => b.dateSort - a.dateSort);
      renderEvents(sorted);
    });

    // Th√®me sombre
    document.getElementById('toggleTheme').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
    });

    // Bouton retour haut
    const backToTop = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        backToTop.classList.add('show');
      } else {
        backToTop.classList.remove('show');
      }
    });
    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>
</body>
</html>
