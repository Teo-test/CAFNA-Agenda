<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda du Club Alpin</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
        darkMode: 'class'
    }
    </script>

  <style>
    /* Animation pour le bouton retour haut */
    #backToTop {
      transition: opacity 0.2s;
      opacity: 0;
      pointer-events: none;
    }
    #backToTop.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* Animation des cartes d'événements */
    .card-appear {
      animation: fadeInUp 0.5s;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px);}
      to { opacity: 1; transform: translateY(0);}
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-green-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">
  <header class="sticky top-0 z-40 bg-white/90 dark:bg-gray-900/90 shadow-sm backdrop-blur transition-colors duration-300">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <h1 class="text-2xl font-bold">📅 Agenda CAFNA</h1>
    <button id="toggleTheme" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 px-3 py-1 rounded">
      🌙 Thème sombre
    </button>
  </div>
</header>

  <div class="max-w-6xl mx-auto px-4 py-6">
  <!-- Filtres et tri regroupés dans une barre sticky et responsive -->
  <div class="md:hidden flex justify-end mb-2">
  <button id="toggleFilters" class="bg-blue-600 text-white px-4 py-2 rounded shadow">
    Filtres & Tri
  </button>
</div>
  <div id="filtersBar"
  class="fixed inset-0 z-50 bg-white dark:bg-gray-900 bg-opacity-95 dark:bg-opacity-95 p-4 flex flex-col gap-4 transition-transform duration-300 transform translate-y-[-100%] md:static md:translate-y-0 md:bg-opacity-100 md:dark:bg-opacity-100 md:p-4 md:flex-row md:items-center md:justify-between md:rounded-lg md:shadow-sm md:mb-6"
>
    <div class="flex justify-end md:hidden mb-2">
      <button id="closeFilters"
    class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 text-2xl text-gray-700 dark:text-gray-200 hover:bg-red-100 hover:text-red-600 dark:hover:bg-red-900 dark:hover:text-red-400 focus:outline-none focus:ring-2 focus:ring-red-400 transition"
    aria-label="Fermer les filtres">
    &times;
  </button>
    </div>
    <!-- Filtres activités -->
    <div class="flex flex-wrap gap-2">
      <button class="filter-btn bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-800 px-3 py-1 rounded font-medium transition" data-activity="Tous">Tous</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Randonnée">Randonnée</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Escalade">Escalade</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Alpinisme">Alpinisme</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Rando alpine">Rando alpine</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Multi-activités">Multi-activités</button>
      <button class="filter-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-1 rounded" data-activity="Formation">Formation</button>
    </div>
    <!-- Recherche -->
    <div class="flex-1 min-w-[200px]">
      <input id="searchInput" type="text" placeholder="🔍 Rechercher par titre ou lieu..."
        class="w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 rounded px-3 py-2 focus:ring-2 focus:ring-blue-400 transition" />
    </div>
    <!-- Tri et disponibilité -->
    <div class="flex flex-wrap gap-2 items-center">
      <button id="sortAsc" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-2 py-1 rounded text-sm" title="Trier par date croissante">Date ↑</button>
      <button id="sortDesc" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-2 py-1 rounded text-sm" title="Trier par date décroissante">Date ↓</button>
      <button id="sortNameAsc" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-2 py-1 rounded text-sm" title="Trier A-Z">A-Z</button>
      <button id="sortNameDesc" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-2 py-1 rounded text-sm" title="Trier Z-A">Z-A</button>
      <select id="availabilityFilter" class="border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 rounded px-2 py-1 text-sm">
        <option value="all">Toutes</option>
        <option value="available">Disponibles</option>
        <option value="full">Complet</option>
      </select>
      <button id="toggleView" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-2 py-1 rounded text-sm" title="Changer la vue">Vue Liste</button>
    </div>
  </div>

    <!-- Conteneur des événements -->
      <div id="events" class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        <div class="text-center py-8">
        <div class="inline-block h-8 w-8 animate-spin border-4 border-blue-600 border-t-transparent rounded-full"></div>
        </div>
        Chargement...
      </div>
    </div>

  <!-- Bouton Retour Haut -->
  <button id="backToTop"
    class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full shadow-lg z-50">
    ↑ Haut
  </button>

  <script>
    const url = "https://clubalpin.nantes.ffcam.fr/index.php?&contentonly=1&moid=3&function=viewsection&oidit=T003:4fp41t2pd7d6&oidsection=b34179abe57cc45535ffcdf0babc96ff&template=viewsection.html&tplentry=it&sectionopts[b34179abe57cc45535ffcdf0babc96ff][first]=0&sectionopts[b34179abe57cc45535ffcdf0babc96ff][insidefilter]=1&activit=&_raw=1&_ajax=1";
    let eventsData = [];
    let isListView = false;


    fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`)
      .then(response => response.json())
      .then(data => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, 'text/html');
        const rows = doc.querySelectorAll('.agenda_liste');
        eventsData = [];

        rows.forEach(row => {
          const activite = row.querySelector('.activite-logo img')?.alt || "Activité inconnue";
          const dateText = row.querySelectorAll('.agenda_listeTop')[0]?.innerText.trim() || "";
          const linkElement = row.querySelector('.agenda_listeTop a');
          const title = linkElement?.textContent.trim() || "Sans titre";
          const link = linkElement?.href || "#";
          const lieu = row.querySelectorAll('.agenda_listeTop')[2]?.innerText.trim() || "";
          const placesBloc = row.querySelectorAll('.agenda_listeTop')[3];
          let places = "";
          let niveauPhysique = "";
          let niveauTechnique = "";
          if (placesBloc) {
            places = placesBloc.innerText.trim().split("\n")[0];
            // Récupération des niveaux via les balises <img>
            const imgs = placesBloc.querySelectorAll('img');
            imgs.forEach(img => {
              if (img.alt && img.alt.toLowerCase().includes('physique')) {
                // Cherche un chiffre dans le nom du fichier (ex: Forme-physique04.png)
                const match = img.src.match(/physique0(\d+)/i);
                niveauPhysique = match ? match[1] : (img.title || img.alt);
              }
              if (img.alt && img.alt.toLowerCase().includes('technique')) {
                const match = img.src.match(/Niveau0?(\d+)/i);
                niveauTechnique = match ? match[1] : (img.title || img.alt);
              }
            });
          }
          const dispo = row.querySelector('.places_restantes')?.innerText || "";
          const contact = row.querySelector('.contact-tel')?.innerText.trim() || "";

          let dateSort = new Date();
          const match = dateText.match(/(\d{2})\/(\d{2})\/(\d{4})/);
          if (match) {
            const [_, d, m, y] = match;
            dateSort = new Date(`${y}-${m}-${d}`);
          }

          eventsData.push({
            activite,
            dateText,
            dateSort,
            title,
            link,
            lieu,
            places,
            niveauPhysique,
            niveauTechnique,
            dispo,
            contact
          });
        });

        renderEvents(eventsData);
        if (Notification.permission === "granted") {
          new Notification("Agenda mis à jour", {
            body: `${eventsData.length} activités chargées.`,
            icon: "https://upload.wikimedia.org/wikipedia/commons/6/6b/FFCAM_logo.png"
          });
        } else if (Notification.permission !== "denied") {
          Notification.requestPermission();
        }
      })
      .catch(err => {
        console.error("Erreur:", err);
        document.getElementById('events').innerHTML = "<p class='text-red-500'>Impossible de charger l'agenda. Vérifiez votre connexion.</p>";
      });

    function renderEvents(data) {
      const container = document.getElementById('events');
      container.innerHTML = "";
      if (data.length === 0) {
        container.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">Aucune activité trouvée.</div>`;
        return;
      }
      data.forEach(ev => {
        const gcalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(ev.title)}&dates=${formatDate(ev.dateSort)}/${formatDate(ev.dateSort)}&details=${encodeURIComponent(ev.link)}&location=${encodeURIComponent(ev.lieu)}&sf=true&output=xml`;
        const card = document.createElement('div');
        card.className = "bg-white dark:bg-gray-800 shadow-lg rounded-xl p-5 flex flex-col justify-between transition-transform duration-200 hover:-translate-y-1 hover:shadow-2xl border border-gray-100 dark:border-gray-700";
        card.classList.add('card-appear');

        if (isListView) {
          card.innerHTML = `
            <div>
              <a href="${ev.link}" target="_blank" class="font-semibold hover:underline">${ev.title}</a>
              <span class="ml-2 text-gray-500 dark:text-gray-300">${ev.dateText}</span>
              <span class="ml-2">${ev.activite}</span>
            </div>
            <div>
              ${ev.inscriptionLink ? `<a href="${ev.inscriptionLink}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded">S'inscrire</a>` : ""}
            </div>
          `;
        } else {
          card.innerHTML = `
                  <div>
                    <div class="flex items-center gap-2 mb-2">
                      <span class="text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">${ev.activite}</span>
                      <span class="text-sm text-gray-500 dark:text-gray-300">${ev.dateText}</span>
                    </div>
                    <h2 class="text-lg font-semibold mb-1">
                      <a href="${ev.link.replace(/^https:\/\/teo-test\.github\.io\//, 'https://clubalpin.nantes.ffcam.fr/')}" target="_blank" class="hover:underline">${ev.title}</a>
                    </h2>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">📍 ${ev.lieu || "<span class='italic text-gray-400'>Lieu non renseigné</span>"}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">👤 ${ev.contact || "<span class='italic text-gray-400'>Contact non renseigné</span>"}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">
                      💪 <span title="Niveau physique">${ev.niveauPhysique || "<span class='italic text-gray-400'>-</span>"}</span>
                      🧗 <span title="Niveau technique">${ev.niveauTechnique || "<span class='italic text-gray-400'>-</span>"}</span>
                    </p>
                  </div>
                  <div class="mt-3 flex flex-wrap gap-2 items-center">
                    <span class="text-sm bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">${ev.places || "Places non renseignées"}</span>
                    ${ev.dispo ? `<span class="text-xs font-semibold px-2 py-1 rounded ${ev.dispo.toLowerCase().includes('complet') ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200' : 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200'}">${ev.dispo}</span>` : ""}
                    ${ev.link ? `<a href="${ev.link.replace(/^https:\/\/teo-test\.github\.io\//, 'https://clubalpin.nantes.ffcam.fr/')}" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-3 py-1 rounded">S'inscrire</a>` : `<span class="inline-block bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 text-sm font-medium px-3 py-1 rounded cursor-not-allowed">Inscription indisponible</span>`}
                    <a href="${gcalUrl}" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 text-white text-sm font-medium px-3 py-1 rounded">📅 Ajouter au calendrier</a>
                  </div>
                `;
                        container.appendChild(card);
              }});
            }

    function formatDate(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}${month}${day}`;
    }

    // Filtrage
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('filter-btn')) {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'text-blue-800', 'dark:text-blue-200', 'font-medium'));
        e.target.classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-800', 'dark:text-blue-200', 'font-medium');
        const activity = e.target.dataset.activity;
        const filtered = activity === "Tous" ? eventsData : eventsData.filter(ev => ev.activite === activity);
        renderEvents(filtered);
      }
    });

    document.getElementById('availabilityFilter').addEventListener('change', (e) => {
      const value = e.target.value;
      let filtered = [...eventsData];

      if (value === "available") {
        filtered = filtered.filter(ev => !ev.dispo.toLowerCase().includes("complet"));
      }
      if (value === "full") {
        filtered = filtered.filter(ev => ev.dispo.toLowerCase().includes("complet"));
      }

      renderEvents(filtered);
    });

    document.getElementById('sortNameAsc').addEventListener('click', () => {
      const sorted = [...eventsData].sort((a, b) => a.title.localeCompare(b.title));
      renderEvents(sorted);
    });
    document.getElementById('sortNameDesc').addEventListener('click', () => {
      const sorted = [...eventsData].sort((a, b) => b.title.localeCompare(a.title));
      renderEvents(sorted);
    });



    // Recherche
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = eventsData.filter(ev =>
        ev.title.toLowerCase().includes(term) || ev.lieu.toLowerCase().includes(term)
      );
      renderEvents(filtered);
    });

    // Tri
    document.getElementById('sortAsc').addEventListener('click', () => {
      const sorted = [...eventsData].sort((a, b) => a.dateSort - b.dateSort);
      renderEvents(sorted);
    });
    document.getElementById('sortDesc').addEventListener('click', () => {
      const sorted = [...eventsData].sort((a, b) => b.dateSort - a.dateSort);
      renderEvents(sorted);
    });

    // Thème sombre
    document.getElementById('toggleTheme').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
    });

    // Bouton retour haut
    const backToTop = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        backToTop.classList.add('show');
      } else {
        backToTop.classList.remove('show');
      }
    });
    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Toggle filters on mobile
    const filtersBar = document.getElementById('filtersBar');
const toggleFilters = document.getElementById('toggleFilters');
const closeFilters = document.getElementById('closeFilters');

toggleFilters?.addEventListener('click', () => {
  filtersBar.classList.remove('translate-y-[-100%]');
  filtersBar.classList.add('translate-y-0');
});

closeFilters?.addEventListener('click', () => {
  filtersBar.classList.add('translate-y-[-100%]');
  filtersBar.classList.remove('translate-y-0');
});
  </script>
</body>
</html>

<!-- Footer -->