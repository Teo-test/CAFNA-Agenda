<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda du Club Alpin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    #backToTop {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
    }
    #backToTop.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    .card-appear {
      animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .filter-btn {
      transition: all 0.2s ease-in-out;
    }
    .filter-btn:hover {
      transform: translateY(-1px);
    }
    .filter-btn.active {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .activity-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .activity-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-green-50 text-gray-800 transition-colors duration-300">
  <header class="sticky top-0 z-40 bg-white/95 shadow-md backdrop-blur-md transition-all duration-300 border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="bg-gradient-to-br from-blue-500 to-purple-600 text-white p-2 rounded-lg shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Agenda CAF</h1>
          <select id="clubSelector" class="text-xs text-gray-700 bg-white border border-gray-300 rounded px-2 py-1 mt-1 focus:outline-none focus:ring-2 focus:ring-blue-400">
            <option value="nantes">Club Alpin Fran√ßais - Nantes</option>
            <option value="paysdelaloire">Club Alpin - Pays de la Loire</option>
          </select>
        </div>
      </div>
      <button id="toggleFilters" class="md:hidden btn-primary text-white px-4 py-2 rounded-lg shadow-lg font-medium flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        Filtres
      </button>
    </div>
  </header>

  <div class="max-w-6xl mx-auto px-4 py-6">
    <div id="filtersBar"
      class="fixed inset-0 z-50 bg-white/98 backdrop-blur-lg p-6 flex flex-col gap-5 transition-transform duration-300 transform -translate-y-full md:static md:translate-y-0 md:bg-white md:p-6 md:flex-row md:items-center md:justify-between md:rounded-2xl md:shadow-lg md:mb-8 md:border md:border-gray-200"
    >
      <div class="flex justify-between items-center md:hidden mb-4">
        <h2 class="text-lg font-bold text-gray-800">Filtres et Tri</h2>
        <button id="closeFilters"
          class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-100 text-gray-600 hover:bg-red-50 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-all shadow-sm"
          aria-label="Fermer les filtres">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="flex flex-wrap gap-2">
        <button class="filter-btn active bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:from-blue-600 hover:to-purple-700 px-4 py-2 rounded-lg font-medium shadow-md" data-activity="Tous">Tous</button>
        <button class="filter-btn bg-white border-2 border-gray-200 text-gray-700 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg font-medium" data-activity="Randonn√©e">ü•æ Randonn√©e</button>
        <button class="filter-btn bg-white border-2 border-gray-200 text-gray-700 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg font-medium" data-activity="Escalade">üßó Escalade</button>
        <button class="filter-btn bg-white border-2 border-gray-200 text-gray-700 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg font-medium" data-activity="Alpinisme">‚õ∞Ô∏è Alpinisme</button>
        <button class="filter-btn bg-white border-2 border-gray-200 text-gray-700 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg font-medium" data-activity="Rando alpine">üèîÔ∏è Rando alpine</button>
        <button class="filter-btn bg-white border-2 border-gray-200 text-gray-700 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg font-medium" data-activity="Multi-activit√©s">üéØ Multi-activit√©s</button>
        <button class="filter-btn bg-white border-2 border-gray-200 text-gray-700 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg font-medium" data-activity="Formation">üìö Formation</button>
      </div>
      <div class="flex-1 min-w-[250px]">
        <div class="relative">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input id="searchInput" type="text" placeholder="Rechercher par titre ou lieu..."
            class="w-full pl-10 pr-4 py-2.5 border-2 border-gray-200 bg-white text-gray-800 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-all shadow-sm" />
        </div>
      </div>
      <div class="flex flex-wrap gap-2 items-center">
        <button id="sortAsc" class="bg-white border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 text-gray-700 hover:text-blue-600 px-3 py-2 rounded-lg text-sm font-medium transition-all shadow-sm" title="Trier par date croissante">üìÖ ‚Üë</button>
        <button id="sortDesc" class="bg-white border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 text-gray-700 hover:text-blue-600 px-3 py-2 rounded-lg text-sm font-medium transition-all shadow-sm" title="Trier par date d√©croissante">üìÖ ‚Üì</button>
        <button id="sortNameAsc" class="bg-white border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 text-gray-700 hover:text-blue-600 px-3 py-2 rounded-lg text-sm font-medium transition-all shadow-sm" title="Trier A-Z">A-Z</button>
        <button id="sortNameDesc" class="bg-white border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 text-gray-700 hover:text-blue-600 px-3 py-2 rounded-lg text-sm font-medium transition-all shadow-sm" title="Trier Z-A">Z-A</button>
        <select id="availabilityFilter" class="border-2 border-gray-200 bg-white text-gray-800 rounded-lg px-3 py-2 text-sm font-medium focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-all shadow-sm">
          <option value="all">Toutes</option>
          <option value="available">‚úÖ Disponibles</option>
          <option value="full">üö´ Complet</option>
        </select>
        <button id="toggleView" class="bg-white border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 text-gray-700 hover:text-blue-600 px-3 py-2 rounded-lg text-sm font-medium transition-all shadow-sm" title="Changer la vue">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <div id="events" class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
      <div class="col-span-full text-center py-12">
        <div class="inline-block h-12 w-12 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"></div>
        <p class="mt-4 text-gray-600 font-medium">Chargement des activit√©s...</p>
      </div>
    </div>
  </div>

  <button id="backToTop"
    class="fixed bottom-6 right-6 btn-primary text-white p-4 rounded-full shadow-2xl z-50 flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
  </button>

  <script>
    let clubsConfig = {};
    let clubUrls = {};
    let clubDomains = {};
    let currentClub = "nantes";
    let eventsData = [];
    let currentEvents = [];
    let isListView = false;

    // Charger la configuration des clubs
    fetch('clubs.json')
      .then(response => response.json())
      .then(data => {
        clubsConfig = data.clubs;
        // Construire les objets clubUrls et clubDomains
        clubsConfig.forEach(club => {
          clubUrls[club.id] = club.agendaUrl;
          clubDomains[club.id] = club.domain;
        });

        // G√©n√©rer les options du s√©lecteur
        const clubSelector = document.getElementById('clubSelector');
        clubSelector.innerHTML = clubsConfig.map(club =>
          `<option value="${club.id}">${club.name}</option>`
        ).join('');

        // Charger le club par d√©faut
        loadClubEvents(currentClub);
      })
      .catch(err => {
        console.error('Erreur lors du chargement de la configuration des clubs:', err);
        // Configuration de secours
        clubUrls = {
          nantes: "https://clubalpin.nantes.ffcam.fr/index.php?&contentonly=1&moid=3&function=viewsection&oidit=T003:4fp41t2pd7d6&oidsection=b34179abe57cc45535ffcdf0babc96ff&template=viewsection.html&tplentry=it&sectionopts[b34179abe57cc45535ffcdf0babc96ff][first]=0&sectionopts[b34179abe57cc45535ffcdf0babc96ff][insidefilter]=1&activit=&_raw=1&_ajax=1",
          paysdelaloire: "https://cr-paysdeloire.ffcam.fr/index.php?&contentonly=1&moid=3&function=viewsection&oidit=T003:4fp41t2pd7d6&oidsection=7ae10ab835a2bedabf04e34c3777d743&template=viewsection.html&tplentry=it&sectionopts[7ae10ab835a2bedabf04e34c3777d743][first]=0&sectionopts[7ae10ab835a2bedabf04e34c3777d743][insidefilter]=1&activit=&_raw=1&_ajax=1&_=1759482169039"
        };
        clubDomains = {
          nantes: "clubalpin.nantes.ffcam.fr",
          paysdelaloire: "cr-paysdeloire.ffcam.fr"
        };
        loadClubEvents(currentClub);
      });

    // Forcer la vue liste sur mobile
    function updateViewMode() {
      if (window.innerWidth < 768) {
        isListView = true;
        document.getElementById('toggleView').textContent = "Vue Cartes";
      } else {
        isListView = false;
        document.getElementById('toggleView').textContent = "Vue Liste";
      }
      renderEvents(currentEvents);
    }
    window.addEventListener('resize', updateViewMode);
    window.addEventListener('DOMContentLoaded', updateViewMode);

    let currentActivity = "Tous";
    let currentAvailability = "all";
    let currentSearch = "";

    function loadClubEvents(club) {
      currentClub = club;
      const url = clubUrls[club];
      document.getElementById('events').innerHTML = `
        <div class="col-span-full text-center py-12">
          <div class="inline-block h-12 w-12 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"></div>
          <p class="mt-4 text-gray-600 font-medium">Chargement des activit√©s...</p>
        </div>`;

      fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`)
        .then(response => response.text())
        .then(data => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(data, 'text/html');
          const rows = doc.querySelectorAll('.agenda_liste');
          eventsData = [];
          rows.forEach(row => {
          const activite = row.querySelector('.activite-logo img')?.alt || "Activit√© inconnue";
          const dateText = row.querySelectorAll('.agenda_listeTop')[0]?.innerText.trim() || "";
          const linkElement = row.querySelector('.agenda_listeTop a');
          const title = linkElement?.textContent.trim() || "Sans titre";
          const link = linkElement?.href || "#";
          const lieu = row.querySelectorAll('.agenda_listeTop')[2]?.innerText.trim() || "";
          const placesBloc = row.querySelectorAll('.agenda_listeTop')[3];
          let places = "", niveauPhysique = "", niveauTechnique = "";
          if (placesBloc) {
            places = placesBloc.innerText.trim().split("\n")[0];
            const imgs = placesBloc.querySelectorAll('img');
            imgs.forEach(img => {
              if (img.alt && img.alt.toLowerCase().includes('physique')) {
                const match = img.src.match(/physique0(\d+)/i);
                niveauPhysique = match ? match[1] : (img.title || img.alt);
              }
              if (img.alt && img.alt.toLowerCase().includes('technique')) {
                const match = img.src.match(/Niveau0?(\d+)/i);
                niveauTechnique = match ? match[1] : (img.title || img.alt);
              }
            });
          }
          const dispo = row.querySelector('.places_restantes')?.innerText || "";
          const contact = row.querySelector('.contact-tel')?.innerText.trim() || "";
          let dateSort = new Date();
          const match = dateText.match(/(\d{2})\/(\d{2})\/(\d{4})/);
          if (match) {
            const [_, d, m, y] = match;
            dateSort = new Date(`${y}-${m}-${d}`);
          }
          eventsData.push({
            activite, dateText, dateSort, title, link, lieu,
            places, niveauPhysique, niveauTechnique, dispo, contact
          });
        });
        const storageKey = `caf_events_ids_${club}`;
        const previousIds = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const currentIds = eventsData.map(ev => ev.title + ev.dateText);

        const newIds = currentIds.filter(id => !previousIds.includes(id));
        if (newIds.length > 0 && Notification.permission === "granted") {
          new Notification("Nouvelle activit√© publi√©e !", {
            body: `${newIds.length} nouvelle(s) activit√©(s) ajout√©e(s) √† l'agenda.`,
            icon: "https://www.ffcam.fr/csx/scripts/resizer.php?filename=STADATA_FFCAM%2Fimg1%2Fed%2F10%2Fi9v62wrpbcp&mime=image%252Fjpeg&originalname=picto_ffcam_couleur.jpg&geometry=270x%3E"
          });
        }
        localStorage.setItem(storageKey, JSON.stringify(currentIds));
        applyFilters();
        if (Notification.permission === "granted") {
          new Notification("Agenda mis √† jour", {
            body: `${eventsData.length} activit√©s charg√©es.`,
            icon: "https://www.ffcam.fr/csx/scripts/resizer.php?filename=STADATA_FFCAM%2Fimg1%2Fed%2F10%2Fi9v62wrpbcp&mime=image%252Fjpeg&originalname=picto_ffcam_couleur.jpg&geometry=270x%3E"
          });
        } else if (Notification.permission !== "denied") {
          Notification.requestPermission();
        }
      })
      .catch(err => {
        document.getElementById('events').innerHTML = "<p class='text-red-500'>Impossible de charger l'agenda. V√©rifiez votre connexion.</p>";
      });
    }

    function renderEvents(data) {
      const container = document.getElementById('events');
      container.innerHTML = "";
      if (isListView) {
        container.className = "space-y-4";
      } else {
        container.className = "grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3";
      }
      if (data.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-16">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-gray-400 text-lg font-medium">Aucune activit√© trouv√©e</p>
            <p class="text-gray-400 text-sm mt-2">Essayez de modifier vos filtres</p>
          </div>`;
        return;
      }
      const currentDomain = clubDomains[currentClub];
      data.forEach(ev => {
        const fixedLink = ev.link.replace(/^https:\/\/teo-test\.github\.io\//, `https://${currentDomain}/`);
        const gcalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(ev.title)}&dates=${formatDate(ev.dateSort)}/${formatDate(ev.dateSort)}&details=${encodeURIComponent(fixedLink)}&location=${encodeURIComponent(ev.lieu)}&sf=true&output=xml`;
        const card = document.createElement('div');
        card.classList.add('card-appear');
        if (isListView) {
          card.className = `
            activity-card flex flex-col md:flex-row items-start md:items-center gap-5 bg-white
            border-2 border-gray-100 rounded-2xl shadow-md px-6 py-5
            hover:shadow-xl hover:border-blue-300 card-appear
          `;
          card.innerHTML = `
            <div class="flex-1 w-full">
              <div class="flex flex-wrap items-center gap-3 mb-3">
                <a href="${fixedLink}" target="_blank" class="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent hover:from-blue-700 hover:to-purple-700 break-all transition-all">${ev.title}</a>
                <span class="text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 text-blue-800 font-semibold">${ev.activite}</span>
                <span class="text-sm text-gray-500 font-medium flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  ${ev.dateText}
                </span>
              </div>
              <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-3">
                <span class="flex items-center gap-1.5" title="Lieu">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  ${ev.lieu || "<span class='italic text-gray-400'>Lieu non renseign√©</span>"}
                </span>
                <span class="flex items-center gap-1.5" title="Contact">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  ${ev.contact || "<span class='italic text-gray-400'>Contact non renseign√©</span>"}
                </span>
              </div>
              <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-3">
                <span class="flex items-center gap-1.5 bg-orange-50 px-3 py-1 rounded-lg" title="Niveau physique">
                  <span class="font-semibold text-orange-600">üí™ Physique:</span>
                  <span class="font-bold text-orange-700">${ev.niveauPhysique || "-"}</span>
                </span>
                <span class="flex items-center gap-1.5 bg-green-50 px-3 py-1 rounded-lg" title="Niveau technique">
                  <span class="font-semibold text-green-600">üßó Technique:</span>
                  <span class="font-bold text-green-700">${ev.niveauTechnique || "-"}</span>
                </span>
              </div>
              <div class="flex items-center gap-3 text-sm">
                <span class="px-3 py-1.5 rounded-lg font-semibold shadow-sm ${ev.dispo && ev.dispo.toLowerCase().includes('complet') ? 'bg-red-100 text-red-700 border border-red-200' : 'bg-green-100 text-green-700 border border-green-200'}">
                  ${ev.dispo && ev.dispo.toLowerCase().includes('complet') ? 'üö´' : '‚úÖ'} ${ev.dispo || "Places non renseign√©es"}
                </span>
                <span class="text-gray-600 font-medium">${ev.places || ""}</span>
              </div>
            </div>
            <div class="flex flex-row md:flex-col gap-3 w-full md:w-auto justify-end">
              ${ev.link ? `<a href="${fixedLink}" target="_blank" class="btn-primary text-white text-sm font-semibold px-5 py-2.5 rounded-lg shadow-lg flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>S'inscrire</a>` : `<span class="inline-block bg-gray-200 text-gray-500 text-sm font-medium px-5 py-2.5 rounded-lg cursor-not-allowed">Inscription indisponible</span>`}
              <a href="${gcalUrl}" target="_blank" class="flex-1 md:flex-none bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-4 py-2.5 rounded-lg text-sm text-center font-semibold shadow-lg transition-all flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Calendrier
              </a>
            </div>
          `;
        } else {
          card.className = "activity-card bg-white shadow-xl rounded-2xl p-6 flex flex-col justify-between border-2 border-gray-100 overflow-hidden group card-appear";
          card.innerHTML = `
            <div>
              <div class="flex items-center justify-between gap-2 mb-3">
                <span class="text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 text-blue-800 font-semibold">${ev.activite}</span>
                <span class="text-sm text-gray-500 font-medium flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  ${ev.dateText}
                </span>
              </div>
              <h2 class="text-lg font-bold mb-3 line-clamp-2">
                <a href="${fixedLink}" target="_blank" class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent hover:from-blue-700 hover:to-purple-700 transition-all">${ev.title}</a>
              </h2>
              <div class="space-y-2 mb-4">
                <p class="text-sm text-gray-600 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <span class="truncate">${ev.lieu || "<span class='italic text-gray-400'>Lieu non renseign√©</span>"}</span>
                </p>
                <p class="text-sm text-gray-600 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  <span class="truncate">${ev.contact || "<span class='italic text-gray-400'>Contact non renseign√©</span>"}</span>
                </p>
              </div>
              <div class="flex gap-2 mb-4">
                <span class="flex items-center gap-1.5 bg-orange-50 px-3 py-1.5 rounded-lg text-xs" title="Niveau physique">
                  <span class="font-semibold text-orange-600">üí™</span>
                  <span class="font-bold text-orange-700">${ev.niveauPhysique || "-"}</span>
                </span>
                <span class="flex items-center gap-1.5 bg-green-50 px-3 py-1.5 rounded-lg text-xs" title="Niveau technique">
                  <span class="font-semibold text-green-600">üßó</span>
                  <span class="font-bold text-green-700">${ev.niveauTechnique || "-"}</span>
                </span>
              </div>
            </div>
            <div class="mt-auto space-y-3">
              <div class="flex flex-wrap items-center gap-2 text-sm">
                <span class="px-3 py-1.5 rounded-lg font-semibold shadow-sm ${ev.dispo && ev.dispo.toLowerCase().includes('complet') ? 'bg-red-100 text-red-700 border border-red-200' : 'bg-green-100 text-green-700 border border-green-200'}">
                  ${ev.dispo && ev.dispo.toLowerCase().includes('complet') ? 'üö´' : '‚úÖ'} ${ev.dispo || ev.places || "Places non renseign√©es"}
                </span>
              </div>
              <div class="flex flex-col gap-2">
                ${ev.link ? `<a href="${fixedLink}" target="_blank" class="btn-primary text-white text-sm font-semibold px-4 py-2.5 rounded-lg shadow-lg text-center flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>S'inscrire</a>` : `<span class="inline-block bg-gray-200 text-gray-500 text-sm font-medium px-4 py-2.5 rounded-lg cursor-not-allowed text-center">Inscription indisponible</span>`}
                <a href="${gcalUrl}" target="_blank" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-4 py-2.5 rounded-lg text-sm text-center font-semibold shadow-lg transition-all flex items-center justify-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  Calendrier
                </a>
              </div>
            </div>
          `;
        }
        container.appendChild(card);
      });
    }

    function formatDate(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}${month}${day}`;
    }

    // Filtrage combin√©
    function applyFilters() {
      let filtered = [...eventsData];
      if (currentActivity !== "Tous") {
        filtered = filtered.filter(ev => ev.activite === currentActivity);
      }
      if (currentAvailability === "available") {
        filtered = filtered.filter(ev => !ev.dispo.toLowerCase().includes("complet"));
      }
      if (currentAvailability === "full") {
        filtered = filtered.filter(ev => ev.dispo.toLowerCase().includes("complet"));
      }
      if (currentSearch) {
        filtered = filtered.filter(ev =>
          ev.title.toLowerCase().includes(currentSearch) ||
          ev.lieu.toLowerCase().includes(currentSearch)
        );
      }
      currentEvents = filtered;
      renderEvents(currentEvents);
    }

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('filter-btn')) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active', 'bg-gradient-to-r', 'from-blue-500', 'to-purple-600', 'text-white', 'shadow-md');
          btn.classList.add('bg-white', 'border-2', 'border-gray-200', 'text-gray-700');
        });
        e.target.classList.remove('bg-white', 'border-2', 'border-gray-200', 'text-gray-700');
        e.target.classList.add('active', 'bg-gradient-to-r', 'from-blue-500', 'to-purple-600', 'text-white', 'shadow-md');
        currentActivity = e.target.dataset.activity;
        applyFilters();
      }
    });

    document.getElementById('availabilityFilter').addEventListener('change', (e) => {
      currentAvailability = e.target.value;
      applyFilters();
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
      currentSearch = e.target.value.toLowerCase();
      applyFilters();
    });

    document.getElementById('sortAsc').addEventListener('click', () => {
      currentEvents = [...currentEvents].sort((a, b) => a.dateSort - b.dateSort);
      renderEvents(currentEvents);
    });
    document.getElementById('sortDesc').addEventListener('click', () => {
      currentEvents = [...currentEvents].sort((a, b) => b.dateSort - a.dateSort);
      renderEvents(currentEvents);
    });
    document.getElementById('sortNameAsc').addEventListener('click', () => {
      currentEvents = [...currentEvents].sort((a, b) => a.title.localeCompare(b.title));
      renderEvents(currentEvents);
    });
    document.getElementById('sortNameDesc').addEventListener('click', () => {
      currentEvents = [...currentEvents].sort((a, b) => b.title.localeCompare(a.title));
      renderEvents(currentEvents);
    });

    // Bouton retour haut
    const backToTop = document.getElementById('backToTop');
    // Remettre le texte dans le bouton si absent
    if (!backToTop.textContent.trim()) {
      backToTop.textContent = "‚Üë";
    }
    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
      backToTop.classList.add('show');
      } else {
      backToTop.classList.remove('show');
      }
    });
    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Toggle filters on mobile
    const filtersBar = document.getElementById('filtersBar');
    const toggleFilters = document.getElementById('toggleFilters');
    const closeFilters = document.getElementById('closeFilters');
    toggleFilters?.addEventListener('click', () => {
      filtersBar.classList.remove('-translate-y-full');
      filtersBar.classList.add('translate-y-0');
    });
    closeFilters?.addEventListener('click', () => {
      filtersBar.classList.add('-translate-y-full');
      filtersBar.classList.remove('translate-y-0');
    });

    // Vue Carte / Liste
    const toggleViewBtn = document.getElementById('toggleView');
    toggleViewBtn.addEventListener('click', () => {
      isListView = !isListView;
      toggleViewBtn.textContent = isListView ? "Vue Cartes" : "Vue Liste";
      renderEvents(currentEvents);
    });

    // S√©lecteur de club
    const clubSelector = document.getElementById('clubSelector');
    clubSelector.addEventListener('change', (e) => {
      loadClubEvents(e.target.value);
    });
  </script>
</body>
</html>
